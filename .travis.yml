language: cpp

compiler:
     - gcc

env:
    global:
        - MONGODB_VERSION=2.6.10

services:
    - mongodb

addons:
    apt:
        sources:
            - ubuntu-toolchain-r-test
        packages:
            - gcc-4.9
            - g++-4.9
before_install:
    - wget http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-$MONGODB_VERSION.tgz
    - tar xfz mongodb-linux-x86_64-$MONGODB_VERSION.tgz
    - export PATH=`pwd`/mongodb-linux-x86_64-$MONGODB_VERSION/bin:$PATH
    - mongod --dbpath=test/data/database &
    - sleep 3
    - export CXX="g++-4.9"
    - export CC="gcc-4.9"
    - sudo ln -sf /usr/bin/gcov-4.9 /usr/bin/gcov
    - gcov --version
    - echo ============ BOOST  INSTALL =============
    - sudo add-apt-repository -y ppa:boost-latest/ppa
    - sudo apt-get update
    - sudo apt-get install libboost1.55-all-dev
    - echo ============ MONGO  INSTALL =============
    - mkdir mongo
    - cd mongo
    - git clone --branch=legacy-1.1.0 https://github.com/mongodb/mongo-cxx-driver.git
    - cd mongo-cxx-driver
    - ls
    - scons -j2 --64 --mute --sharedclient --prefix=$HOME/mongo-cxx install
    - ls $HOME/mongo-cxx
    - cd ../../
    - echo ============ ASSIMP INSTALL =============
    - mkdir assimp
    - cd assimp
    - git clone --branch=ISSUE_1 https://github.com/3drepo/assimp.git      
    - CXXFLAGS+=-std=c++11 cmake -DASSIMP_BUILD_TESTS=OFF assimp
    - sudo make -j2 install
    - cd ../
install:
    - sudo pip install cpp-coveralls    
before_script:
    - ls
    - mkdir build && cd build
    - MONGO_ROOT=$HOME/mongo-cxx cmake -DREPO_BUILD_CLIENT=ON -DREPO_BUILD_TESTS=ON  -DCMAKE_BUILD_TYPE=Release ../
script:
    - sudo make -j2 install
    - LD_LIBRARY_PATH=$HOME/mongo-cxx/lib/:/usr/local/lib:$LD_LIBRARY_PATH 3drepobouncerTest
after_success:
    - coveralls --root ../ -e "test" -e "submodules" -e "cmake_modules" -e "tools" -e "mongo" -e "assimp"
notifications:
    email: 
        recipients:
            - carmen.fan@3drepo.org
