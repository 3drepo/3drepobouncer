language: cpp

compiler:
     - gcc
addons:
    apt:
        sources:
            - ubuntu-toolchain-r-test
        packages:
            - gcc-4.9
            - g++-4.9
before_install:
    - export CXX="g++-4.9"
    - export CC="gcc-4.9"
    - echo ============ BOOST  INSTALL =============
    - sudo add-apt-repository -y ppa:boost-latest/ppa
    - sudo apt-get update
    - sudo apt-get install libboost1.55-all-dev
    - echo ============ MONGO  INSTALL =============
    - mkdir mongo
    - cd mongo
    - git clone --branch=legacy-1.1.0 https://github.com/mongodb/mongo-cxx-driver.git
    - cd mongo-cxx-driver
    - ls
    - scons -j2 --64 --mute --sharedclient --prefix=$HOME/mongo-cxx install
    - ls $HOME/mongo-cxx
    - cd ../../
    - echo ============ ASSIMP INSTALL =============
    - mkdir assimp
    - cd assimp
    - git clone --branch=ISSUE_1 https://github.com/3drepo/assimp.git      
    - CXXFLAGS+=-std=c++11 cmake -DASSIMP_BUILD_TESTS=OFF assimp
    - sudo make -j2 install
    - cd ../
install:
    - wget http://ftp.de.debian.org/debian/pool/main/l/lcov/lcov_1.11.orig.tar.gz
    - tar xf lcov_1.11.orig.tar.gz
    - sudo make -C lcov-1.11/ install
    - gem install coveralls-lcov
before_script:
    - ls
    - MONGO_ROOT=$HOME/mongo-cxx cmake -DREPO_BUILD_CLIENT=ON -DREPO_BUILD_TESTS=ON  -DCMAKE_BUILD_TYPE=Release .
script:
    - sudo make -j2 install
    - LD_LIBRARY_PATH=$HOME/mongo-cxx/lib/:/usr/local/lib:$LD_LIBRARY_PATH ldd /usr/local/bin/3drepobouncerTest
    - ls /usr/local/lib
    - LD_LIBRARY_PATH=$HOME/mongo-cxx/lib/:/usr/local/lib:$LD_LIBRARY_PATH 3drepobouncerTest
after_success:
    - lcov --directory . --capture --output-file coverage.info
    - lcov --remove coverage.info 'test/*' '/usr/*' --output-file coverage.info # filter out system and test code
    - lcov --list coverage.info # debug before upload
    - coveralls-lcov --repo-token ${COVERALLS_TOKEN} coverage.info      
notifications:
    email: 
        recipients:
            - team@3drepo.org
